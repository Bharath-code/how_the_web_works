---

---

<div
    id="tts-player"
    class="fixed bottom-6 right-6 z-50 hidden md:flex items-center gap-2 bg-black text-white px-4 py-3 rounded-full shadow-2xl border border-white/10 transition-transform translate-y-24 opacity-0 data-[visible=true]:translate-y-0 data-[visible=true]:opacity-100 duration-500"
>
    <button
        id="tts-play"
        class="hover:text-accent transition-colors"
        aria-label="Play Audio"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><polygon points="5 3 19 12 5 21 5 3"></polygon></svg
        >
    </button>
    <button
        id="tts-pause"
        class="hidden hover:text-accent transition-colors"
        aria-label="Pause Audio"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><rect x="6" y="4" width="4" height="16"></rect><rect
                x="14"
                y="4"
                width="4"
                height="16"></rect></svg
        >
    </button>
    <button
        id="tts-stop"
        class="hover:text-red-400 transition-colors"
        aria-label="Stop Audio"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg
        >
    </button>

    <div class="w-px h-4 bg-white/20 mx-1"></div>

    <span
        id="tts-status"
        class="font-mono text-xs font-bold uppercase tracking-widest"
        >Listen</span
    >
</div>

<script>
    class TTSController {
        private synth: SpeechSynthesis;
        private utterance: SpeechSynthesisUtterance | null = null;
        private isPlaying: boolean = false;
        private isPaused: boolean = false;
        private contentToRead: string = "";

        // UI Elements
        private container: HTMLElement | null;
        private playBtn: HTMLElement | null;
        private pauseBtn: HTMLElement | null;
        private stopBtn: HTMLElement | null;
        private statusText: HTMLElement | null;

        constructor() {
            this.synth = window.speechSynthesis;

            this.container = document.getElementById("tts-player");
            this.playBtn = document.getElementById("tts-play");
            this.pauseBtn = document.getElementById("tts-pause");
            this.stopBtn = document.getElementById("tts-stop");
            this.statusText = document.getElementById("tts-status");

            if (this.synth) {
                this.init();
            }
        }

        private init() {
            // Reveal player
            setTimeout(() => {
                this.container?.setAttribute("data-visible", "true");
            }, 1000);

            // Extract text from the article, ignoring code blocks if possible or reading them minimally
            // Simple approach: Get innerText of the article
            const article = document.querySelector("article");
            if (article) {
                // Clone to modify before extraction
                const clone = article.cloneNode(true) as HTMLElement;

                // Remove code blocks from reading to avoid annoyance?
                // Creating a "clean" reading version.
                // For now, let's keep it simple.
                this.contentToRead = clone.innerText;
            }

            this.playBtn?.addEventListener("click", () => this.play());
            this.pauseBtn?.addEventListener("click", () => this.pause());
            this.stopBtn?.addEventListener("click", () => this.stop());

            // Handle page navigation cleanup (Astro View Transitions compatible if added later)
            document.addEventListener("astro:before-swap", () => {
                this.stop();
            });
        }

        private play() {
            if (this.isPaused) {
                this.synth.resume();
                this.isPaused = false;
                this.updateUI("playing");
                return;
            }

            if (this.synth.speaking) {
                this.synth.cancel();
            }

            this.utterance = new SpeechSynthesisUtterance(this.contentToRead);

            // Select a good voice if available
            const voices = this.synth.getVoices();
            const preferredVoice = voices.find(
                (v) =>
                    v.name.includes("Google US English") ||
                    v.name.includes("Samantha"),
            );
            if (preferredVoice) this.utterance.voice = preferredVoice;

            this.utterance.rate = 1.0;
            this.utterance.pitch = 1.0;

            this.utterance.onend = () => {
                this.isPlaying = false;
                this.isPaused = false;
                this.updateUI("stopped");
            };

            this.synth.speak(this.utterance);
            this.isPlaying = true;
            this.updateUI("playing");
        }

        private pause() {
            if (this.synth.speaking && !this.synth.paused) {
                this.synth.pause();
                this.isPaused = true;
                this.updateUI("paused");
            }
        }

        private stop() {
            this.synth.cancel();
            this.isPlaying = false;
            this.isPaused = false;
            this.updateUI("stopped");
        }

        private updateUI(state: "playing" | "paused" | "stopped") {
            if (state === "playing") {
                this.playBtn?.classList.add("hidden");
                this.pauseBtn?.classList.remove("hidden");
                if (this.statusText) this.statusText.innerText = "Playing...";
            } else if (state === "paused") {
                this.playBtn?.classList.remove("hidden");
                this.pauseBtn?.classList.add("hidden");
                if (this.statusText) this.statusText.innerText = "Paused";
            } else {
                this.playBtn?.classList.remove("hidden");
                this.pauseBtn?.classList.add("hidden");
                if (this.statusText) this.statusText.innerText = "Listen";
            }
        }
    }

    // Initialize on load
    // Support browsers where voices load asynchronously
    window.speechSynthesis.onvoiceschanged = () => {
        // re-init if needed to get voices, but constructor handles main logic
    };

    const player = new TTSController();
</script>
