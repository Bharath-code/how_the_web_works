---
import "@pagefind/default-ui/css/ui.css";
---

<div id="search-container" class="contents">
    <button
        id="search-trigger"
        class="group flex items-center gap-2 px-3 py-1.5 rounded-md border border-black/10 bg-black/5 hover:bg-black/10 hover:border-black/20 transition-all text-sm font-mono text-black/60"
        aria-label="Search"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><circle cx="11" cy="11" r="8"></circle><line
                x1="21"
                y1="21"
                x2="16.65"
                y2="16.65"></line></svg
        >
        <span class="hidden md:inline">Search</span>
        <span
            class="hidden md:inline text-[10px] border border-black/10 rounded px-1 bg-white/50"
            >âŒ˜K</span
        >
    </button>

    <dialog
        id="search-dialog"
        class="backdrop:bg-black/20 backdrop:backdrop-blur-sm bg-transparent p-0 w-full max-w-2xl mx-auto rounded-xl shadow-2xl focus:outline-none open:animate-in open:fade-in open:slide-in-from-bottom-4 open:duration-300"
    >
        <div
            class="bg-background border border-black/10 rounded-xl overflow-hidden flex flex-col max-h-[70vh] md:max-h-[600px] transition-all duration-300 group"
        >
            <div
                id="pagefind-ui"
                class="p-4 md:p-6 w-full h-full overflow-y-auto"
            >
            </div>

            <!-- Focus Mode: Suggestions & Recent Searches -->
            <div
                id="search-focus-extras"
                class="px-4 md:px-6 pb-6 pt-2 border-t border-black/5 bg-black/[0.02] animation-delay-100 animate-in fade-in slide-in-from-top-2"
            >
                <div class="space-y-6">
                    <!-- Recent Searches -->
                    <div id="recent-searches-section" class="hidden">
                        <h3
                            class="text-[10px] font-bold uppercase tracking-widest text-black/30 mb-3"
                        >
                            Recent Searches
                        </h3>
                        <div
                            id="recent-searches-list"
                            class="flex flex-wrap gap-2"
                        >
                            <!-- Injected by JS -->
                        </div>
                    </div>

                    <!-- Suggested Topics -->
                    <div>
                        <h3
                            class="text-[10px] font-bold uppercase tracking-widest text-black/30 mb-3"
                        >
                            Suggested Topics
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            {
                                [
                                    "Execution Context",
                                    "Event Loop",
                                    "Closure",
                                    "Prototypal Inheritance",
                                    "Modules",
                                ].map((topic) => (
                                    <button
                                        type="button"
                                        class="suggestion-pill px-3 py-1 rounded-full border border-black/10 bg-white text-xs font-medium hover:border-black/30 hover:bg-black/5 transition-all"
                                        data-topic={topic}
                                    >
                                        {topic}
                                    </button>
                                ))
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
</div>

<script>
    class SearchController {
        private dialog: HTMLDialogElement | null;
        private trigger: HTMLElement | null;
        private extras: HTMLElement | null;
        private initialized: boolean = false;
        private RECENT_KEY = "hww_recent_searches";

        constructor() {
            this.dialog = document.getElementById(
                "search-dialog",
            ) as HTMLDialogElement;
            this.trigger = document.getElementById("search-trigger");
            this.extras = document.getElementById("search-focus-extras");

            if (this.trigger && this.dialog) {
                this.init();
            }
        }

        private async initPagefind() {
            if (this.initialized) return;

            const { PagefindUI } = await import("@pagefind/default-ui");
            new PagefindUI({
                element: "#pagefind-ui",
                showSubResults: true,
                showImages: false,
                translations: {
                    placeholder: "Search documentation...",
                },
            });
            this.initialized = true;

            setTimeout(() => {
                const input = this.dialog?.querySelector("input");
                if (input) {
                    input.addEventListener("input", (e) => {
                        const target = e.target as HTMLInputElement;
                        this.handleInput(target.value);
                    });

                    // Add listeners to suggestion pills
                    this.dialog
                        ?.querySelectorAll(".suggestion-pill")
                        .forEach((pill) => {
                            pill.addEventListener("click", (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                const topic = (pill as HTMLElement).dataset
                                    .topic;
                                if (topic) {
                                    this.applySearch(topic);
                                }
                            });
                        });
                }
            }, 150);
        }

        private applySearch(query: string) {
            const input = this.dialog?.querySelector("input");
            if (input) {
                input.value = query;
                input.dispatchEvent(new Event("input", { bubbles: true }));
                input.focus();
                this.handleInput(query);
            }
        }

        private handleInput(value: string) {
            const hasQuery = value.trim().length > 0;
            if (hasQuery) {
                this.dialog?.setAttribute("data-has-query", "true");
                this.extras?.classList.add("hidden");
            } else {
                this.dialog?.removeAttribute("data-has-query");
                this.extras?.classList.remove("hidden");
                this.renderRecentSearches();
            }
        }

        private saveSearch(query: string) {
            if (!query || query.length < 3) return;
            const recent = this.getRecent();
            const updated = [query, ...recent.filter((i) => i !== query)].slice(
                0,
                5,
            );
            localStorage.setItem(this.RECENT_KEY, JSON.stringify(updated));
        }

        private getRecent(): string[] {
            try {
                return JSON.parse(
                    localStorage.getItem(this.RECENT_KEY) || "[]",
                );
            } catch {
                return [];
            }
        }

        private renderRecentSearches() {
            const recent = this.getRecent();
            const section = document.getElementById("recent-searches-section");
            const list = document.getElementById("recent-searches-list");

            if (recent.length > 0 && section && list) {
                section.classList.remove("hidden");
                list.innerHTML = recent
                    .map(
                        (q) => `
                    <button type="button" class="recent-pill px-3 py-1 rounded-full border border-black/5 bg-black/5 text-xs text-black/60 hover:bg-black/10 transition-all font-mono" data-query="${q}">
                        ${q}
                    </button>
                `,
                    )
                    .join("");

                list.querySelectorAll(".recent-pill").forEach((pill) => {
                    pill.addEventListener("click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const query = (pill as HTMLElement).dataset.query;
                        if (query) {
                            this.applySearch(query);
                        }
                    });
                });
            } else if (section) {
                section.classList.add("hidden");
            }
        }

        private init() {
            this.trigger?.addEventListener("click", () => this.open());

            document.addEventListener("keydown", (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === "k") {
                    e.preventDefault();
                    this.open();
                }
                if (e.key === "Escape" && this.dialog?.open) {
                    this.close();
                }
                // Save search on Enter if there's a query
                if (e.key === "Enter" && this.dialog?.open) {
                    const input = this.dialog.querySelector("input");
                    if (input && input.value) {
                        this.saveSearch(input.value);
                    }
                }
            });

            // Improved click-outside logic
            this.dialog?.addEventListener("click", (e) => {
                if (e.target === this.dialog) {
                    this.close();
                }
            });
        }

        private async open() {
            await this.initPagefind();
            this.dialog?.showModal();
            this.handleInput("");
            this.renderRecentSearches();

            // More robust input reset
            const resetInput = () => {
                const input = this.dialog?.querySelector("input");
                if (input) {
                    input.value = "";
                    input.focus();
                    this.handleInput("");
                    return true;
                }
                return false;
            };

            if (!resetInput()) {
                // Try a few times if Pagefind is still rendering
                let attempts = 0;
                const interval = setInterval(() => {
                    if (resetInput() || attempts++ > 10) {
                        clearInterval(interval);
                    }
                }, 50);
            }
        }

        private close() {
            this.dialog?.close();
        }
    }

    // Clear existing content to prevent duplicates (e.g. from HMR or persistence)
    const container = document.getElementById("pagefind-ui");
    if (container) container.innerHTML = "";

    // Re-init on view transition (handles initial load too)
    document.addEventListener("astro:page-load", () => {
        new SearchController();
    });
</script>

<style is:global>
    /* Dialog positioning & Motion */
    #search-dialog {
        margin-top: 30vh;
        transition: margin-top 0.6s cubic-bezier(0.19, 1, 0.22, 1);
    }

    #search-dialog[data-has-query="true"] {
        margin-top: 8vh;
    }

    /* Editorial Aesthetic Overrides */
    :root {
        --pagefind-ui-scale: 0.9;
        --pagefind-ui-primary: #000;
        --pagefind-ui-text: #1a1a1a;
        --pagefind-ui-background: transparent;
        --pagefind-ui-border: transparent;
        --pagefind-ui-font: "Inter", sans-serif;
    }

    /* Input Styling */
    #pagefind-ui .pagefind-ui__search-input {
        font-family: "JetBrains Mono", monospace;
        font-weight: 500;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.03);
        padding: 0.75rem 1rem 0.75rem 2.75rem;
        transition: all 0.2s ease;
    }

    #pagefind-ui .pagefind-ui__search-input:focus {
        background: #fff;
        border-color: #000;
        box-shadow:
            0 10px 25px -5px rgba(0, 0, 0, 0.1),
            0 8px 10px -6px rgba(0, 0, 0, 0.1);
    }

    /* Staggered Results Animation */
    #pagefind-ui .pagefind-ui__result {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1.5rem 0;
        animation: revealIn 0.5s cubic-bezier(0.19, 1, 0.22, 1) both;
    }

    /* Sequentially delay results (assuming up to 5 visible) */
    #pagefind-ui .pagefind-ui__result:nth-child(1) {
        animation-delay: 50ms;
    }
    #pagefind-ui .pagefind-ui__result:nth-child(2) {
        animation-delay: 100ms;
    }
    #pagefind-ui .pagefind-ui__result:nth-child(3) {
        animation-delay: 150ms;
    }
    #pagefind-ui .pagefind-ui__result:nth-child(4) {
        animation-delay: 200ms;
    }
    #pagefind-ui .pagefind-ui__result:nth-child(5) {
        animation-delay: 250ms;
    }

    @keyframes revealIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Typography & UX details */
    #pagefind-ui .pagefind-ui__result-title {
        font-family: "Playfair Display", serif;
        font-weight: 700;
        font-size: 1.1rem;
        color: #000;
        margin-bottom: 0.25rem;
    }

    #pagefind-ui .pagefind-ui__result-link {
        text-decoration: none;
    }

    #pagefind-ui .pagefind-ui__result-link:hover .pagefind-ui__result-title {
        text-decoration: underline;
    }

    #pagefind-ui .pagefind-ui__result-excerpt {
        color: #666;
        font-size: 0.875rem;
        line-height: 1.5;
    }

    #pagefind-ui mark {
        background: rgba(0, 0, 0, 0.05);
        color: #000;
        font-weight: 600;
        border-radius: 2px;
        padding: 0 2px;
    }

    #pagefind-ui .pagefind-ui__message {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: rgba(0, 0, 0, 0.3);
        margin-top: 1rem;
    }
</style>
