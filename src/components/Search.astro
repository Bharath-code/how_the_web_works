---
import "@pagefind/default-ui/css/ui.css";
---

<div id="search-container" class="contents">
    <button
        id="search-trigger"
        class="group flex items-center gap-2 px-3 py-1.5 rounded-md border border-black/10 bg-black/5 hover:bg-black/10 hover:border-black/20 transition-all text-sm font-mono text-black/60"
        aria-label="Search"
    >
        <svg
            xmlns="http://www.w3.org/2000/svg"
            width="14"
            height="14"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><circle cx="11" cy="11" r="8"></circle><line
                x1="21"
                y1="21"
                x2="16.65"
                y2="16.65"></line></svg
        >
        <span class="hidden md:inline">Search</span>
        <span
            class="hidden md:inline text-[10px] border border-black/10 rounded px-1 bg-white/50"
            >âŒ˜K</span
        >
    </button>

    <dialog
        id="search-dialog"
        class="backdrop:bg-black/20 backdrop:backdrop-blur-sm bg-transparent p-0 w-full max-w-2xl mx-auto rounded-xl shadow-2xl focus:outline-none open:animate-in open:fade-in open:slide-in-from-bottom-4 open:duration-200"
    >
        <div
            class="bg-background border border-black/10 rounded-xl overflow-hidden flex flex-col max-h-[60vh] md:max-h-[500px]"
        >
            <div
                id="pagefind-ui"
                class="p-4 md:p-6 w-full h-full overflow-y-auto"
            >
            </div>
        </div>
    </dialog>
</div>

<script>
    class SearchController {
        private dialog: HTMLDialogElement | null;
        private trigger: HTMLElement | null;
        private initialized: boolean = false;

        constructor() {
            this.dialog = document.getElementById(
                "search-dialog",
            ) as HTMLDialogElement;
            this.trigger = document.getElementById("search-trigger");

            if (this.trigger && this.dialog) {
                this.init();
            }
        }

        private async initPagefind() {
            if (this.initialized) return;

            // Dynamic import to avoid loading CSS/JS on initial page load if possible,
            // but Pagefind UI expects to be present.
            // Using the standard UI for reliability in this implementation.
            const { PagefindUI } = await import("@pagefind/default-ui");
            new PagefindUI({
                element: "#pagefind-ui",
                showSubResults: true,
                showImages: false,
                translations: {
                    placeholder: "Search documentation...",
                },
            });
            this.initialized = true;

            // Hook into the input generated by Pagefind
            // We need to wait a tick for DOM to update
            setTimeout(() => {
                const input = this.dialog?.querySelector("input");
                if (input) {
                    input.addEventListener("input", (e) => {
                        const target = e.target as HTMLInputElement;
                        this.handleInput(target.value);
                    });
                }
            }, 100);
        }

        private handleInput(value: string) {
            if (value.trim().length > 0) {
                this.dialog?.setAttribute("data-has-query", "true");
            } else {
                this.dialog?.removeAttribute("data-has-query");
            }
        }

        private init() {
            // Click trigger
            this.trigger?.addEventListener("click", () => {
                this.open();
            });

            // Keyboard shortcut
            document.addEventListener("keydown", (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === "k") {
                    e.preventDefault();
                    this.open();
                }
                if (e.key === "Escape" && this.dialog?.open) {
                    this.close();
                }
            });

            // Click outside to close
            this.dialog?.addEventListener("click", (e) => {
                const rect = this.dialog!.getBoundingClientRect();
                const isInDialog =
                    rect.top <= e.clientY &&
                    e.clientY <= rect.top + rect.height &&
                    rect.left <= e.clientX &&
                    e.clientX <= rect.left + rect.width;
                if (!isInDialog) {
                    this.close();
                }
            });
        }

        private async open() {
            await this.initPagefind();
            this.dialog?.showModal();
            // Reset state on open
            this.handleInput("");

            // Focus internal input slightly later
            setTimeout(() => {
                const input = this.dialog?.querySelector("input");
                if (input) {
                    input.value = ""; // Clear previous
                    input.focus();
                    this.handleInput(""); // Ensure reset
                }
            }, 50);
        }

        private close() {
            this.dialog?.close();
            // Optional: clear input on close?
            // Leaving it keeps state, but cleaner to reset for "center" effect next time
        }
    }

    // Clear existing content to prevent duplicates (e.g. from HMR or persistence)
    const container = document.getElementById("pagefind-ui");
    if (container) container.innerHTML = "";

    // Re-init on view transition (handles initial load too)
    document.addEventListener("astro:page-load", () => {
        new SearchController();
    });
</script>

<style is:global>
    /* Dialog positioning */
    #search-dialog {
        /* Default: Center vertically (approximate with margin) */
        margin-top: 35vh;
        transition:
            margin-top 0.4s cubic-bezier(0.16, 1, 0.3, 1),
            overlay 0.4s allow-discrete,
            display 0.4s allow-discrete;
    }

    /* When typing: Move to top */
    #search-dialog[data-has-query="true"] {
        margin-top: 10vh;
    }

    /* Customize Pagefind UI to match aesthetic */
    :root {
        --pagefind-ui-scale: 0.9;
        --pagefind-ui-primary: #000;
        --pagefind-ui-text: #333;
        --pagefind-ui-background: #fff;
        --pagefind-ui-border: #eee;
        --pagefind-ui-tag: #eee;
        --pagefind-ui-border-width: 1px;
        --pagefind-ui-border-radius: 8px;
        --pagefind-ui-image-border-radius: 8px;
        --pagefind-ui-image-box-ratio: 3 / 2;
        --pagefind-ui-font: "Inter", sans-serif;
    }

    #pagefind-ui .pagefind-ui__search-input {
        font-family: "JetBrains Mono", monospace;
        font-weight: 500;
        border: 2px solid #000;
        border-radius: 8px;
    }

    #pagefind-ui .pagefind-ui__search-input:focus {
        outline: none;
        border-color: #000;
        box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.1);
    }

    #pagefind-ui .pagefind-ui__drawer {
        gap: 20px;
    }

    #pagefind-ui .pagefind-ui__result {
        border-bottom: 1px solid #eee;
        padding-bottom: 16px;
    }

    #pagefind-ui .pagefind-ui__result-title {
        font-family: "Playfair Display", serif;
        font-weight: 700;
    }

    #pagefind-ui .pagefind-ui__result-thumb {
        display: none; /* Hide images for minimalism */
    }
</style>
